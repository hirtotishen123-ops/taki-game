<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAKI PRO - V5 FORCE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff4d4d; --bg: #0a2b12; }
        * { box-sizing: border-box; user-select: none; font-family: sans-serif; }
        body { margin: 0; background: var(--bg); color: white; height: 100dvh; overflow: hidden; }

        /* 住 住 拽 转专 */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-board { display: none; width: 100vw; height: 100dvh; position: relative; }
        
        .btn { padding: 15px 35px; background: var(--gold); border: none; border-radius: 25px; font-weight: bold; cursor: pointer; color: black; font-size: 18px; }
        .player-slot { position: absolute; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; text-align: center; min-width: 100px; border: 2px solid transparent; }
        .active-turn { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        #slot-bottom { bottom: 120px; left: 50%; transform: translateX(-50%); }
        #slot-top { top: 20px; left: 50%; transform: translateX(-50%); }
        #slot-left { top: 40%; left: 10px; }
        #slot-right { top: 40%; right: 10px; }

        .card { width: 50px; height: 75px; background: white; border-radius: 5px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: black; border: 1px solid #000; margin: 2px; }
        .c-red { background: var(--red); color: white; }
        .c-blue { background: #4d94ff; color: white; }
        .c-green { background: #4dff88; color: black; }
        .c-yellow { background: #ffff4d; color: black; }
        .c-special { background: #222; color: var(--gold); border: 2px solid var(--gold); }

        #my-hand { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; overflow-x: auto; padding: 10px; z-index: 100; }
        #center-area { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 15px; }
        
        .ice-cream-alert { color: #ff99cc; font-size: 12px; display: block; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color:var(--gold)">TAKI PRO</h1>
    <input type="text" id="user-name" style="padding:15px; border-radius:10px; border:none; width:200px; text-align:center;" placeholder="拽 砖...">
    <br>
    <button class="btn" onclick="forceJoin()">住 转</button>
</div>

<div id="game-board">
    <div id="admin-controls" style="display:none; position:absolute; top:10px; left:10px; z-index:500;">
        <button class="btn" style="font-size:12px; padding:8px;" onclick="startGame()">拽 拽驻</button>
        <button class="btn" style="font-size:12px; padding:8px; background:red; color:white;" onclick="resetGame()">驻住</button>
    </div>

    <div id="slot-top" class="player-slot"></div>
    <div id="slot-left" class="player-slot"></div>
    <div id="slot-right" class="player-slot"></div>
    <div id="slot-bottom" class="player-slot"></div>

    <div id="center-area">
        <div class="card c-special" onclick="drawCard()" style="cursor:pointer">拽驻</div>
        <div id="discard-pile"></div>
    </div>
    
    <div id="my-hand"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let uid = null;
    let uName = "";
    let isManager = false;
    let localPlayers = [];
    let currentGameState = {};

    function forceJoin() {
        const nameInput = document.getElementById('user-name');
        uName = nameInput.value.trim();
        if (!uName) return;

        // 住转专 转 砖 住 住
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-board').style.display = 'block';

        if (uName === "") {
            isManager = true;
            document.getElementById('admin-controls').style.display = 'block';
        }

        // 爪专转 砖拽 -Firebase
        const playerRef = database.ref('players').push();
        uid = playerRef.key;
        playerRef.set({ id: uid, name: uName, cardCount: 0 });
        playerRef.onDisconnect().remove();

        initSync();
    }

    function initSync() {
        // 住专 砖拽
        database.ref('players').on('value', snap => {
            const data = snap.val() || {};
            localPlayers = Object.keys(data);
            renderPlayers(data);
        });

        // 住专 爪 砖拽
        database.ref('game_state').on('value', snap => {
            currentGameState = snap.val() || {};
            renderTable();
        });

        // 住专  砖转
        database.ref(`player_hands/${uid}`).on('value', snap => {
            renderMyHand(snap.val() || []);
            database.ref(`players/${uid}/cardCount`).set((snap.val() || []).length);
        });

        // 住专 驻住
        database.ref('reset_trigger').on('value', snap => {
            if (snap.val() === true && !isManager) location.reload();
        });
    }

    function renderPlayers(allPlayers) {
        const slots = ['slot-bottom', 'slot-left', 'slot-top', 'slot-right'];
        slots.forEach(s => document.getElementById(s).style.display = 'none');

        const myIndex = localPlayers.indexOf(uid);
        if (myIndex === -1) return;

        localPlayers.forEach((pid, index) => {
            let position = (index - myIndex + localPlayers.length) % localPlayers.length;
            let slotId = (position === 0) ? 'slot-bottom' : (position === 1) ? (localPlayers.length === 2 ? 'slot-top' : 'slot-left') : (position === 2) ? 'slot-top' : 'slot-right';
            
            const el = document.getElementById(slotId);
            el.style.display = 'block';
            el.className = `player-slot ${currentGameState.turn === pid ? 'active-turn' : ''}`;
            
            let label = (position === 0) ? "" : allPlayers[pid].name;
            let html = `<b>${label}</b><br> ${allPlayers[pid].cardCount || 0}`;
            
            if (allPlayers[pid].name.includes("专")) {
                html += `<span class="ice-cream-alert" id="ice-${pid}">驻注  转拽  </span>`;
                setTimeout(() => { if(document.getElementById(`ice-${pid}`)) document.getElementById(`ice-${pid}`).style.visibility = 'hidden'; }, 2000);
            }
            el.innerHTML = html;
        });
    }

    function renderTable() {
        const discard = document.getElementById('discard-pile');
        if (currentGameState.topCard) {
            const c = currentGameState.topCard;
            discard.innerHTML = `<div class="card c-${c.color}">${c.val}</div>`;
        }
    }

    function renderMyHand(cards) {
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = '';
        cards.forEach((c, i) => {
            const cardEl = document.createElement('div');
            cardEl.className = `card c-${c.color}`;
            cardEl.innerHTML = c.val;
            cardEl.onclick = () => playCard(i, c);
            handDiv.appendChild(cardEl);
        });
    }

    function playCard(index, card) {
        if (currentGameState.turn !== uid) return;
        database.ref(`player_hands/${uid}`).once('value', snap => {
            let hand = snap.val();
            hand.splice(index, 1);
            database.ref(`player_hands/${uid}`).set(hand);
            database.ref('game_state').update({
                topCard: card,
                turn: localPlayers[(localPlayers.indexOf(uid) + 1) % localPlayers.length]
            });
        });
    }

    function drawCard() {
        if (currentGameState.turn !== uid) return;
        database.ref(`player_hands/${uid}`).once('value', snap => {
            let hand = snap.val() || [];
            hand.push(generateRandomCard());
            database.ref(`player_hands/${uid}`).set(hand);
            database.ref('game_state/turn').set(localPlayers[(localPlayers.indexOf(uid) + 1) % localPlayers.length]);
        });
    }

    function generateRandomCard() {
        const colors = ['red', 'blue', 'green', 'yellow'];
        const vals = ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'stop', 'taki'];
        return { color: colors[Math.floor(Math.random() * 4)], val: vals[Math.floor(Math.random() * vals.length)] };
    }

    function startGame() {
        localPlayers.forEach(pid => {
            let hand = [];
            for (let i = 0; i < 8; i++) hand.push(generateRandomCard());
            database.ref(`player_hands/${pid}`).set(hand);
        });
        database.ref('game_state').set({
            turn: localPlayers[0],
            topCard: generateRandomCard()
        });
        database.ref('reset_trigger').set(false);
    }

    function resetGame() {
        database.ref('reset_trigger').set(true);
        database.ref('game_state').remove();
        database.ref('player_hands').remove();
    }
</script>
</body>
</html>
