<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAKI ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* ×”×’×“×¨×•×ª ×‘×¡×™×¡ - ××™×¤×•×¡ ×•×¢×™×¦×•×‘ ××¤×œ×™×§×˜×™×‘×™ */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; height: 100vh; width: 100vw; color: white; }

        /* ××¡×š ×›× ×™×¡×” */
        #login-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #2c3e50, #000);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .title { font-size: 50px; color: #f1c40f; text-shadow: 0 0 20px #f1c40f; margin-bottom: 20px; font-weight: bold; letter-spacing: 2px; }
        .input-box { padding: 15px; font-size: 18px; border-radius: 30px; border: 2px solid #f1c40f; background: rgba(255,255,255,0.1); color: white; text-align: center; width: 300px; margin-bottom: 20px; outline: none; }
        .btn-start { padding: 15px 40px; background: #f1c40f; color: black; font-weight: bold; font-size: 20px; border-radius: 30px; border: none; cursor: pointer; box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4); transition: 0.2s; }
        .btn-start:active { transform: scale(0.95); }

        /* ×œ×•×— ×”××©×—×§ - ×¢×™×¦×•×‘ ×©×•×œ×—×Ÿ */
        #game-board {
            display: none; width: 100vw; height: 100vh; position: relative;
            background: radial-gradient(circle, #27ae60 20%, #083818 90%);
        }
        
        /* ××–×•×¨ ××™×“×¢ ×•×¦'××˜ (×¦×“ ×©×××œ) */
        #sidebar {
            position: absolute; top: 0; left: 0; bottom: 0; width: 220px;
            background: rgba(0,0,0,0.6); border-right: 2px solid #f1c40f;
            display: flex; flex-direction: column; padding: 10px; z-index: 100;
        }
        #chat-area { flex: 1; overflow-y: auto; font-size: 13px; text-shadow: 1px 1px 1px black; margin-bottom: 10px; }
        .chat-msg { margin-bottom: 4px; }
        #chat-input { background: rgba(255,255,255,0.2); border: none; padding: 8px; color: white; border-radius: 5px; width: 100%; }
        #admin-panel { margin-top: 10px; border-top: 1px solid #555; padding-top: 10px; display: none; }
        .btn-admin { width: 100%; margin-bottom: 5px; padding: 8px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }

        /* ××–×•×¨ ×”×©×•×œ×—×Ÿ ×•×”×§×œ×¤×™× */
        #table-center {
            position: absolute; top: 50%; left: 55%; transform: translate(-50%, -50%);
            display: flex; gap: 30px; align-items: center;
        }

        /* ×§×œ×¤×™× */
        .card {
            width: 70px; height: 100px; background: white; border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 24px; position: relative; border: 4px solid white; cursor: pointer;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-10px); z-index: 10; }
        /* ×¦×‘×¢×™ ×§×œ×¤×™× */
        .card.red { background: #e74c3c; color: white; border-color: white; }
        .card.blue { background: #3498db; color: white; border-color: white; }
        .card.green { background: #2ecc71; color: white; border-color: white; }
        .card.yellow { background: #f1c40f; color: black; border-color: white; }
        .card.special { background: linear-gradient(135deg, #333, #000); color: #f1c40f; border-color: #f1c40f; } /* ×˜××§×™/×©×™× ×•×™ ×¦×‘×¢ */
        
        /* ×§×•×¤×” */
        #deck { background: linear-gradient(45deg, #2c3e50, #000); color: white; border: 2px solid #fff; cursor: pointer; }

        /* ××™×§×•××™ ×©×—×§× ×™× */
        .player-slot {
            position: absolute; width: 100px; height: 100px;
            background: rgba(0,0,0,0.5); border-radius: 15px; border: 2px solid #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .avatar { font-size: 30px; margin-bottom: 5px; }
        .p-name { font-size: 14px; font-weight: bold; }
        .p-cards { font-size: 12px; color: #f1c40f; }
        
        /* ××¡×’×¨×ª ×ª×•×¨ ×–×•×”×¨×ª */
        .active-turn { border-color: #f1c40f; box-shadow: 0 0 20px #f1c40f; background: rgba(241, 196, 15, 0.2); transform: scale(1.1); }

        /* ××™×§×•××™× ××‘×¡×•×œ×•×˜×™×™× */
        #slot-top { top: 20px; left: 55%; transform: translateX(-50%); }
        #slot-left { top: 50%; left: 240px; transform: translateY(-50%); }
        #slot-right { top: 50%; right: 20px; transform: translateY(-50%); }
        
        /* ×”×™×“ ×©×œ×™ */
        #my-hand-container {
            position: absolute; bottom: 10px; left: 240px; right: 20px; height: 120px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            overflow-x: auto; padding: 10px;
        }

        /* ×‘×•×—×¨ ×¦×‘×¢ */
        #color-picker {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center; gap: 20px;
        }
        .color-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; cursor: pointer; transition: 0.2s; }
        .color-btn:hover { transform: scale(1.1); }

        /* ×›×¤×ª×•×¨ ×¡×’×™×¨×ª ×˜××§×™ */
        #close-taki-btn {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            padding: 10px 30px; background: linear-gradient(45deg, #e74c3c, #c0392b); color: white;
            font-weight: bold; border-radius: 20px; cursor: pointer; display: none;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }

        /* ×”×•×“×¢×•×ª ××¢×¨×›×ª */
        #game-msg {
            position: absolute; top: 150px; left: 55%; transform: translateX(-50%);
            font-size: 24px; color: white; text-shadow: 0 0 10px black; font-weight: bold; 
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="title">TAKI ULTIMATE</div>
        <input type="text" id="username" class="input-box" placeholder="×©× ×©×—×§×Ÿ ××• '×× ×”×œ'">
        <button class="btn-start" onclick="joinGame()">×›× ×¡ ×œ××©×—×§</button>
        <p style="color:#aaa; font-size:12px; margin-top:20px;">××•××œ×¥ ×œ×©×—×§ ×‘××¦×‘ ×œ×¨×•×—×‘ (Landscape)</p>
    </div>

    <div id="game-board">
        <div id="sidebar">
            <h3 style="color:#f1c40f; text-align:center; border-bottom:1px solid #555; padding-bottom:10px;">×¦'××˜ ×©×•×œ×—×Ÿ</h3>
            <div id="chat-area"></div>
            <input type="text" id="chat-input" placeholder="×›×ª×•×‘ ×›××Ÿ...">
            
            <div id="admin-panel">
                <button class="btn-admin" style="background:#f1c40f;" onclick="startGame()">×—×œ×§ ×§×œ×¤×™× ×•×”×ª×—×œ</button>
                <button class="btn-admin" style="background:#e74c3c; color:white;" onclick="resetGame()">××™×¤×•×¡ ××•×—×œ×˜</button>
            </div>
        </div>

        <div id="slot-top" class="player-slot" style="display:none">
            <div class="avatar">ğŸ‘¤</div>
            <div class="p-name">×©×</div>
            <div class="p-cards">0 ×§×œ×¤×™×</div>
        </div>
        <div id="slot-left" class="player-slot" style="display:none">
            <div class="avatar">ğŸ‘¤</div>
            <div class="p-name">×©×</div>
            <div class="p-cards">0 ×§×œ×¤×™×</div>
        </div>
        <div id="slot-right" class="player-slot" style="display:none">
            <div class="avatar">ğŸ‘¤</div>
            <div class="p-name">×©×</div>
            <div class="p-cards">0 ×§×œ×¤×™×</div>
        </div>

        <div id="game-msg"></div>

        <div id="table-center">
            <div id="deck" class="card" onclick="drawFromDeck()">×§×•×¤×”</div>
            <div id="pile"></div> </div>

        <div id="close-taki-btn" onclick="closeTaki()">×¡×’×•×¨ ×˜××§×™</div>

        <div id="my-hand-container"></div>
    </div>

    <div id="color-picker">
        <div class="color-btn" style="background:#e74c3c;" onclick="pickColor('red')"></div>
        <div class="color-btn" style="background:#3498db;" onclick="pickColor('blue')"></div>
        <div class="color-btn" style="background:#2ecc71;" onclick="pickColor('green')"></div>
        <div class="color-btn" style="background:#f1c40f;" onclick="pickColor('yellow')"></div>
    </div>

<script>
    // --- ×”×’×“×¨×•×ª Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
    let myId, myName, isAdmin = false;
    let gameState = {};
    let myHand = [];
    let isMyTurn = false;
    let inTakiMode = false;

    // --- ×œ×•×’×™×§×ª ×›× ×™×¡×” ---
    function joinGame() {
        const input = document.getElementById('username').value.trim();
        if(!input) return alert("×—×•×‘×” ×œ×”×›× ×™×¡ ×©×");
        
        if(input === "×× ×”×œ") {
            isAdmin = true;
            myName = prompt("×©× ×”×× ×”×œ ×‘××©×—×§:") || "×”×× ×”×œ";
            document.getElementById('admin-panel').style.display = 'block';
        } else {
            myName = input;
        }

        const ref = db.ref('players').push();
        myId = ref.key;
        ref.set({ id: myId, name: myName, cardCount: 0, online: true });
        ref.onDisconnect().remove();

        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('game-board').style.display = 'block';

        initListeners();
    }

    // --- ×××–×™× ×™× ×‘×–××Ÿ ×××ª ---
    function initListeners() {
        // ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘××©×—×§ (×ª×•×¨, ×§×œ×£ ×¢×œ×™×•×Ÿ)
        db.ref('gameState').on('value', snap => {
            gameState = snap.val() || {};
            updateUI();
        });

        // ×”××–× ×” ×œ×©×—×§× ×™×
        db.ref('players').on('value', snap => {
            renderPlayers(snap.val() || {});
        });

        // ×”××–× ×” ×œ×™×“ ×©×œ×™
        db.ref(`hands/${myId}`).on('value', snap => {
            myHand = snap.val() || [];
            renderHand();
            // ×¢×“×›×•×Ÿ ×›××•×ª ×§×œ×¤×™× ×œ×©××¨ ×”×©×—×§× ×™×
            db.ref(`players/${myId}/cardCount`).set(myHand.length);
        });

        // ×”××–× ×” ×œ×¦'××˜
        db.ref('chat').on('value', snap => {
            const area = document.getElementById('chat-area');
            area.innerHTML = '';
            snap.forEach(msg => {
                const m = msg.val();
                area.innerHTML += `<div class="chat-msg"><b>${m.user}:</b> ${m.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    // --- ×¢×“×›×•×Ÿ ×××©×§ ---
    function updateUI() {
        if(!gameState.pile) return;
        
        // ×”×¦×’×ª ×”×§×œ×£ ×‘××¨×›×–
        const pileEl = document.getElementById('pile');
        pileEl.className = `card ${gameState.pile.color}`;
        if(gameState.pile.type === 'special') pileEl.classList.add('special');
        pileEl.innerHTML = getCardSymbol(gameState.pile);

        // ×‘×“×™×§×ª ×ª×•×¨
        isMyTurn = (gameState.turn === myId);
        
        // ×›×¤×ª×•×¨ ×¡×’×™×¨×ª ×˜××§×™
        const takiBtn = document.getElementById('close-taki-btn');
        if(isMyTurn && gameState.inTakiRun) {
            takiBtn.style.display = 'block';
            inTakiMode = true;
        } else {
            takiBtn.style.display = 'none';
            inTakiMode = false;
        }
    }

    function renderPlayers(players) {
        const ids = Object.keys(players);
        // ×¡×™×“×•×¨ ×™×—×¡×™: ×× ×™ ×ª××™×“ ×œ××˜×”, ×”×©××¨ ××¡×ª×•×‘×‘×™×
        let myIndex = ids.indexOf(myId);
        if(myIndex === -1) return; // ×œ× × ××¦×

        const offsets = [
            { id: 'slot-right', idx: (myIndex + 1) % ids.length },
            { id: 'slot-top', idx: (myIndex + 2) % ids.length },
            { id: 'slot-left', idx: (myIndex + 3) % ids.length }
        ];

        // ××™×¤×•×¡
        document.querySelectorAll('.player-slot').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.player-slot').forEach(el => el.classList.remove('active-turn'));

        // ×”×¦×’×”
        offsets.forEach(pos => {
            if(ids.length > pos.idx && ids[pos.idx] !== myId) {
                const pId = ids[pos.idx];
                const pData = players[pId];
                if(pData) {
                    const el = document.getElementById(pos.id);
                    el.style.display = 'flex';
                    el.querySelector('.p-name').innerText = pData.name;
                    el.querySelector('.p-cards').innerText = `${pData.cardCount} ×§×œ×¤×™×`;
                    if(gameState.turn === pId) el.classList.add('active-turn');
                }
            }
        });
        
        // ××™× ×“×™×§×¦×™×” ×× ×ª×•×¨×™
        if(gameState.turn === myId) showMsg("×ª×•×¨×š!");
    }

    function renderHand() {
        const container = document.getElementById('my-hand-container');
        container.innerHTML = '';
        myHand.forEach((card, index) => {
            const div = document.createElement('div');
            div.className = `card ${card.color}`;
            if(card.type === 'special') div.classList.add('special');
            div.innerHTML = getCardSymbol(card);
            div.onclick = () => playCard(index, card);
            container.appendChild(div);
        });
    }

    function getCardSymbol(card) {
        if(card.value === 'change_color') return 'ğŸ¨';
        if(card.value === 'taki') return 'TAKI';
        if(card.value === 'stop') return 'âœ‹';
        if(card.value === 'plus2') return '+2';
        if(card.value === 'change_dir') return 'â‡„';
        return card.value;
    }

    // --- ×œ×•×’×™×§×ª ××©×—×§ (Game Engine) ---
    
    function playCard(index, card) {
        if(!isMyTurn) { showMsg("×œ× ×ª×•×¨×š!"); return; }
        
        const top = gameState.pile;
        let isValid = false;

        // ×—×•×§×™ ×˜××§×™ ×‘×¡×™×¡×™×™×
        if(inTakiMode) {
            // ×‘×ª×•×š ×˜××§×™ - ×—×™×™×‘ ×œ×”×™×•×ª ××•×ª×• ×¦×‘×¢
            if(card.color === top.color) isValid = true;
        } else {
            // ×¨×’×™×œ - ××•×ª×• ×¦×‘×¢ ××• ××•×ª×• ×¢×¨×š ××• ××™×•×—×“
            if(card.color === top.color || card.value === top.value || card.value === 'change_color') isValid = true;
        }

        if(!isValid) { showMsg("××”×œ×š ×œ× ×—×•×§×™"); return; }

        // ×‘×™×¦×•×¢ ×”××”×œ×š
        // 1. ×”×¡×¨×” ××”×™×“
        const newHand = [...myHand];
        newHand.splice(index, 1);
        db.ref(`hands/${myId}`).set(newHand);

        // 2. ×˜×™×¤×•×œ ×‘×§×œ×¤×™× ××™×•×—×“×™×
        if(card.value === 'change_color') {
            document.getElementById('color-picker').style.display = 'flex';
            // ×œ× ××¢×‘×™×¨×™× ×ª×•×¨ ×¢×“×™×™×Ÿ
            return; 
        }

        // ×¢×“×›×•×Ÿ ×”×§×œ×£ ×‘×©×•×œ×—×Ÿ
        db.ref('gameState/pile').set(card);

        if(card.value === 'taki' && !inTakiMode) {
            db.ref('gameState/inTakiRun').set(true);
            showMsg("×˜××§×™ ×¤×ª×•×—!");
            return; // ×œ× ××¢×‘×™×¨×™× ×ª×•×¨
        }

        if(card.value === 'stop') {
            passTurn(2); // ×“×œ×’
        } else if(card.value === 'change_dir') {
             // ×”×—×œ×¤×ª ×›×™×•×•×Ÿ (×¤×©×˜×ª×™ ××ª ×–×” ×œ××©×—×§ ××”×™×¨ - ×¤×©×•×˜ ××“×œ×’ ×¨×’×™×œ ×›×¨×’×¢ ×›×™ ×–×” ××•×¨×›×‘ ××“×™ ×œ-JSON ×¤×©×•×˜)
             passTurn(1);
        } else if (inTakiMode) {
            // ×× ×× ×—× ×• ×‘×˜××§×™, ×œ× ××¢×‘×™×¨×™× ×ª×•×¨, ××œ× ×× × ×’××¨×• ×”×§×œ×¤×™×
            if(newHand.length === 0) closeTaki();
        } else {
            passTurn(1);
        }
    }

    function drawFromDeck() {
        if(!isMyTurn) return;
        if(inTakiMode) {
            // ××¡×•×¨ ×œ×§×—×ª ×§×œ×£ ×‘×××¦×¢ ×˜××§×™, ×¦×¨×™×š ×œ×¡×’×•×¨
            closeTaki(); 
            return;
        }

        // ×”×’×¨×œ×ª ×§×œ×£
        const colors = ['red', 'blue', 'green', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9','stop','plus2','taki','change_dir'];
        
        // ×¡×™×›×•×™ ×§×˜×Ÿ ×œ××™×•×—×“×™×
        let c = colors[Math.floor(Math.random()*4)];
        let v = values[Math.floor(Math.random()*values.length)];
        
        // ×¡×™×›×•×™ ×§×˜×Ÿ ×œ×©×™× ×•×™ ×¦×‘×¢
        if(Math.random() < 0.05) { c = 'special'; v = 'change_color'; }

        const newCard = { color: c, value: v, type: (v==='change_color'||v==='taki')?'special':'normal' };
        
        const newHand = [...myHand, newCard];
        db.ref(`hands/${myId}`).set(newHand);
        passTurn(1);
    }

    function pickColor(color) {
        document.getElementById('color-picker').style.display = 'none';
        // ××©× ×™× ××ª ×¦×‘×¢ ×”×§×œ×£ ×©×¢×œ ×”×©×•×œ×—×Ÿ
        db.ref('gameState/pile/color').set(color);
        passTurn(1);
    }

    function closeTaki() {
        db.ref('gameState/inTakiRun').set(false);
        passTurn(1);
    }

    function passTurn(steps) {
        db.ref('players').once('value', snap => {
            const ids = Object.keys(snap.val());
            const currentIdx = ids.indexOf(myId);
            let nextIdx = (currentIdx + steps) % ids.length;
            db.ref('gameState/turn').set(ids[nextIdx]);
        });
    }

    // --- × ×™×”×•×œ (Admin) ---
    function startGame() {
        const colors = ['red', 'blue', 'green', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9','stop','plus2','taki']; // ×—×¤×™×¡×” ×‘×¡×™×¡×™×ª ×œ×”×ª×—×œ×”

        // ×™×¦×™×¨×ª ××¦×‘ ×”×ª×—×œ×ª×™
        db.ref('gameState').set({
            pile: { color: 'red', value: '1', type: 'normal' },
            turn: myId, // ×”×× ×”×œ ××ª×—×™×œ
            inTakiRun: false
        });

        // ×—×œ×•×§×ª ×§×œ×¤×™× ×œ×›×•×œ×
        db.ref('players').once('value', snap => {
            snap.forEach(p => {
                let hand = [];
                for(let i=0; i<8; i++) {
                    let c = colors[Math.floor(Math.random()*4)];
                    let v = values[Math.floor(Math.random()*values.length)];
                    if(Math.random() < 0.1) { c='special'; v='change_color'; }
                    hand.push({ color: c, value: v, type: (v==='change_color'||v==='taki')?'special':'normal' });
                }
                db.ref(`hands/${p.key}`).set(hand);
            });
        });
        
        db.ref('chat').push({ user: '××¢×¨×›×ª', text: '×”××©×—×§ ×”×—×œ! ×‘×”×¦×œ×—×”.' });
    }

    function resetGame() {
        if(confirm("×‘×˜×•×—? ×–×” ×™××—×§ ×”×›×œ.")) {
            db.ref('/').remove();
            location.reload();
        }
    }

    // --- ×¢×–×¨×™× ---
    function showMsg(txt) {
        const el = document.getElementById('game-msg');
        el.innerText = txt;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
    }

    // Enter ×œ×¦××˜
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') {
            db.ref('chat').push({ user: myName, text: e.target.value });
            e.target.value = '';
        }
    });

</script>
</body>
</html>
