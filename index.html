<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAKI MOBILE PRO</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* ××™×¤×•×¡ ×•×”×’×“×¨×•×ª ×‘×¡×™×¡ */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: #111; overflow: hidden; height: 100vh; width: 100vw; color: white; }

        /* ××¡×š "× × ×œ×¡×•×‘×‘ ××›×©×™×¨" */
        #rotate-msg {
            display: none; position: fixed; inset: 0; background: #000; z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        @media (orientation: portrait) { #rotate-msg { display: flex; } }

        /* ××¡×š ×›× ×™×¡×” */
        #login-screen {
            position: fixed; inset: 0; background: radial-gradient(circle, #333, #000); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .input-box { font-size: 20px; padding: 10px; border-radius: 10px; text-align: center; width: 60%; margin: 10px; }
        .btn-main { font-size: 20px; padding: 10px 40px; background: gold; border: none; border-radius: 30px; font-weight: bold; box-shadow: 0 0 15px gold; }

        /* ×œ×•×— ×”××©×—×§ */
        #game-ui { display: none; width: 100%; height: 100%; position: relative; background: radial-gradient(circle, #2e7d32 0%, #0d2b11 100%); }

        /* ×§×œ×¤×™× - ×¢×™×¦×•×‘ ×“××•×™ ××§×•×¨ */
        .card {
            width: 12vh; height: 18vh; border-radius: 1vh; background: white; 
            position: relative; display: flex; align-items: center; justify-content: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); border: 0.3vh solid white; transition: 0.2s;
        }
        .card-inner { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 8vh; border-radius: 0.5vh; }
        
        /* ×¦×‘×¢×™× */
        .c-red { background: #e63946; color: white; }
        .c-green { background: #2a9d8f; color: white; }
        .c-blue { background: #0077b6; color: white; }
        .c-yellow { background: #ffb703; color: black; }
        .c-special { background: linear-gradient(135deg, #222, #444); color: gold; border: 2px solid gold; }

        /* ×¡××œ×™× ××™×•×—×“×™× */
        .symbol-stop::after { content: "âœ‹"; font-size: 6vh; }
        .symbol-plus2::after { content: "+2"; }
        .symbol-change::after { content: "â‡„"; font-size: 8vh; }
        .symbol-taki { font-size: 4vh; transform: rotate(-10deg); text-shadow: 2px 2px 0 #000; }
        .symbol-color { font-size: 6vh; background: conic-gradient(red, yellow, green, blue); -webkit-background-clip: text; color: transparent; }

        /* ××™×§×•××™ ×©×—×§× ×™× - ××•×ª×× ×œ××—×•×–×™× */
        .player-spot { 
            position: absolute; padding: 5px; background: rgba(0,0,0,0.6); border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; min-width: 15vw;
        }
        .p-name { font-size: 2.5vh; font-weight: bold; color: white; }
        .p-cards { font-size: 2vh; color: gold; }
        
        /* ××™×§×•××™× ×™×—×¡×™×™× */
        #spot-top { top: 2%; left: 50%; transform: translateX(-50%); }
        #spot-left { top: 40%; left: 2%; transform: translateY(-50%); }
        #spot-right { top: 40%; right: 2%; transform: translateY(-50%); }
        
        /* ××–×•×¨ ×©×œ×™ ×œ××˜×” */
        #my-area {
            position: absolute; bottom: 0; width: 100%; height: 22vh; 
            display: flex; align-items: flex-end; justify-content: center; padding-bottom: 2vh;
            gap: -2vw; /* ×§×œ×¤×™× ×—×•×¤×¤×™× */
        }
        .my-card { margin-left: -2vh; transform: translateY(0); transition: 0.2s; cursor: pointer; }
        .my-card:hover { transform: translateY(-3vh); z-index: 10; }

        /* ×©×•×œ×—×Ÿ ××¨×›×–×™ */
        #center-table {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 4vw; align-items: center;
        }
        #deck { background: #333; color: #fff; cursor: pointer; border: 2px solid gold; }
        
        /* ×—×™×•×•×™ ×ª×•×¨ */
        .active-turn { border: 3px solid gold; box-shadow: 0 0 20px gold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; } }

        /* ×ª×¤×¨×™×˜ ×× ×”×œ ×•×¦'××˜ */
        #menu-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px; border-radius: 5px; z-index: 100; font-size: 12px; }
        #admin-panel { display: none; position: absolute; top: 40px; left: 10px; background: rgba(0,0,0,0.9); padding: 10px; border: 1px solid gold; z-index: 101; }
        
        /* ×‘×•×¨×¨ ×¦×‘×¢ */
        #color-picker { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center; gap: 20px; }
        .cp-btn { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; }

        /* ×›×¤×ª×•×¨ ×¡×’×™×¨×ª ×˜××§×™ */
        #close-taki { display: none; position: absolute; bottom: 25vh; left: 50%; transform: translateX(-50%); background: red; color: white; padding: 10px 30px; border-radius: 20px; font-weight: bold; box-shadow: 0 0 10px red; z-index: 200; }
        
        /* ×”×•×“×¢×•×ª */
        #toast { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; font-size: 20px; opacity: 0; pointer-events: none; transition: 0.3s; color: gold; border: 1px solid gold; z-index: 500; text-align: center; }

    </style>
</head>
<body>

    <div id="rotate-msg">
        <h1 style="color:gold; font-size: 50px;">â†»</h1>
        <h2>× × ×œ×¡×•×‘×‘ ××ª ×”×˜×œ×¤×•×Ÿ</h2>
        <p>×”××©×—×§ ×¢×•×‘×“ ×¨×§ ×œ×¨×•×—×‘</p>
    </div>

    <div id="login-screen">
        <h1 style="color: gold; font-size: 40px; margin-bottom: 0;">TAKI PRO</h1>
        <p style="color:#aaa;">×’×¨×¡×” ××•×ª×××ª ×œ× ×™×™×“</p>
        <input type="text" id="username" class="input-box" placeholder="×”×›× ×¡ ×©×...">
        <button class="btn-main" onclick="joinGame()">×©×—×§!</button>
    </div>

    <div id="game-ui">
        <div id="toast"></div>

        <button id="menu-btn" onclick="toggleMenu()">â˜° ×ª×¤×¨×™×˜</button>
        <div id="admin-panel">
            <button onclick="startGame()" style="background:gold; width:100%; margin-bottom:5px;">×—×œ×§ ×§×œ×¤×™×</button>
            <button onclick="resetGame()" style="background:red; color:white; width:100%;">××™×¤×•×¡ ××©×—×§</button>
            <div id="chat-box" style="height:100px; overflow-y:auto; color:white; font-size:10px; margin-top:5px; border-top:1px solid #555;"></div>
        </div>

        <div id="spot-top" class="player-spot" style="display:none">
            <div class="p-name"></div><div class="p-cards"></div>
        </div>
        <div id="spot-left" class="player-spot" style="display:none">
            <div class="p-name"></div><div class="p-cards"></div>
        </div>
        <div id="spot-right" class="player-spot" style="display:none">
            <div class="p-name"></div><div class="p-cards"></div>
        </div>

        <div id="center-table">
            <div id="deck" class="card" onclick="drawCard()">
                <div class="card-inner" style="background:#222; color:gold; font-size:3vh;">TAKI</div>
            </div>
            <div id="pile"></div>
        </div>

        <div id="close-taki" onclick="closeTaki()">×¡×’×•×¨ ×˜××§×™</div>

        <div id="my-area"></div>
    </div>

    <div id="color-picker">
        <div class="cp-btn" style="background:#e63946" onclick="selectColor('red')"></div>
        <div class="cp-btn" style="background:#2a9d8f" onclick="selectColor('green')"></div>
        <div class="cp-btn" style="background:#0077b6" onclick="selectColor('blue')"></div>
        <div class="cp-btn" style="background:#ffb703" onclick="selectColor('yellow')"></div>
    </div>

<script>
    const config = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    firebase.initializeApp(config);
    const db = firebase.database();

    let myId, myName, isAdmin = false;
    let gameState = { turn: null, pile: null, inTaki: false };
    let myHand = [];
    let playersList = []; // ×¨×©×™××ª ID ×©×œ ×©×—×§× ×™× ×œ×—×™×©×•×‘ ××™×§×•×

    function joinGame() {
        const nameInput = document.getElementById('username').value.trim();
        if (!nameInput) return alert("×—×™×™×‘ ×©×!");

        if (nameInput === "×× ×”×œ") {
            isAdmin = true;
            myName = prompt("×©× ×”×× ×”×œ:") || "×× ×”×œ";
            document.getElementById('admin-panel').style.display = 'block';
        } else {
            myName = nameInput;
        }

        const ref = db.ref('players').push();
        myId = ref.key;
        ref.set({ id: myId, name: myName, cardCount: 0 });
        ref.onDisconnect().remove();

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';

        initGame();
    }

    function initGame() {
        // ×”××–× ×” ×œ××¦×‘ ××©×—×§
        db.ref('gameState').on('value', snap => {
            gameState = snap.val() || {};
            updatePile();
            checkTurn();
        });

        // ×”××–× ×” ×œ×©×—×§× ×™× (×œ×¦×•×¨×š ×—×™×©×•×‘ ××™×§×•××™×)
        db.ref('players').on('value', snap => {
            const data = snap.val() || {};
            playersList = Object.keys(data);
            updatePlayersUI(data);
        });

        // ×”××–× ×” ×œ×™×“ ×©×œ×™
        db.ref(`hands/${myId}`).on('value', snap => {
            myHand = snap.val() || [];
            renderHand();
            db.ref(`players/${myId}/cardCount`).set(myHand.length);
        });
        
        // ×¦'××˜
        db.ref('chat').on('child_added', snap => {
            const m = snap.val();
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div>${m.text}</div>`;
        });
    }

    // --- ×××©×§ ---
    
    function updatePile() {
        if(!gameState.pile) return;
        const p = document.getElementById('pile');
        p.className = `card c-${gameState.pile.color}`;
        p.innerHTML = renderCardContent(gameState.pile);
    }

    function renderCardContent(card) {
        let cls = '';
        if(card.value === 'stop') cls = 'symbol-stop';
        else if(card.value === '+2') cls = 'symbol-plus2';
        else if(card.value === 'change_dir') cls = 'symbol-change';
        else if(card.value === 'taki') { cls = 'symbol-taki'; return `<div class="card-inner ${cls}">TAKI</div>`; }
        else if(card.value === 'change_color') { cls = 'symbol-color'; return `<div class="card-inner ${cls}">ğŸ¨</div>`; }
        else return `<div class="card-inner" style="font-size:8vh">${card.value}</div>`;
        
        return `<div class="card-inner ${cls}"></div>`;
    }

    function renderHand() {
        const area = document.getElementById('my-area');
        area.innerHTML = '';
        myHand.forEach((c, i) => {
            const el = document.createElement('div');
            el.className = `card my-card c-${c.color}`;
            if(c.color === 'special') el.classList.add('c-special');
            el.innerHTML = renderCardContent(c);
            el.onclick = () => playCard(i, c);
            area.appendChild(el);
        });
    }

    function updatePlayersUI(playersData) {
        // ××™×¤×•×¡
        ['spot-left', 'spot-top', 'spot-right'].forEach(id => document.getElementById(id).style.display = 'none');
        document.querySelectorAll('.player-spot').forEach(e => e.classList.remove('active-turn'));

        const myIndex = playersList.indexOf(myId);
        if(myIndex === -1) return;

        // ×—×™×©×•×‘ ××™×§×•××™× ×™×—×¡×™×™× (××¢×’×œ)
        const spots = [
            { offset: 1, el: 'spot-left' }, // ×”×©×—×§×Ÿ ×”×‘× ××©×××œ
            { offset: 2, el: 'spot-top' },  // ××•×œ×™
            { offset: 3, el: 'spot-right' } // ××™××™×Ÿ
        ];

        spots.forEach(spot => {
            if(playersList.length > spot.offset) {
                // ×œ×•×’×™×§×” ××¢×’×œ×™×ª ×œ××¦×™××ª ×”××™× ×“×§×¡ ×”× ×›×•×Ÿ
                const targetIdx = (myIndex + spot.offset) % playersList.length;
                // ×× ×”×’×¢× ×• ×œ×¢×¦×× ×• (×‘××©×—×§ ×©×œ 2 ×©×—×§× ×™× ×œ××©×œ), ××“×œ×’×™×
                if(targetIdx === myIndex) return;
                
                const targetId = playersList[targetIdx];
                const p = playersData[targetId];
                
                if(p) {
                    const el = document.getElementById(spot.el);
                    el.style.display = 'flex';
                    el.querySelector('.p-name').innerText = p.name;
                    el.querySelector('.p-cards').innerText = `ğŸ´ ${p.cardCount}`;
                    if(gameState.turn === targetId) el.classList.add('active-turn');
                }
            }
        });

        // ×¡×™××•×Ÿ ×ª×•×¨ ×©×œ×™
        if(gameState.turn === myId) showToast("×ª×•×¨×š!");
        
        // ×›×¤×ª×•×¨ ×¡×’×™×¨×ª ×˜××§×™
        document.getElementById('close-taki').style.display = (gameState.turn === myId && gameState.inTaki) ? 'block' : 'none';
    }

    function checkTurn() {
        const deck = document.getElementById('deck');
        if(gameState.turn === myId) {
            deck.style.borderColor = 'gold';
            deck.style.boxShadow = '0 0 15px gold';
        } else {
            deck.style.borderColor = 'white';
            deck.style.boxShadow = 'none';
        }
    }

    // --- ×œ×•×’×™×§×ª ××©×—×§ ---

    function playCard(index, card) {
        if (gameState.turn !== myId) return showToast("×œ× ×ª×•×¨×š!");

        const top = gameState.pile;
        let valid = false;

        // ×—×•×§×™×
        if (gameState.inTaki) {
            if (card.color === top.color) valid = true;
        } else {
            if (card.color === top.color || card.value === top.value || card.color === 'special') valid = true;
        }

        if (!valid) return showToast("××”×œ×š ×œ× ×—×•×§×™");

        // ×‘×—×™×¨×ª ×¦×‘×¢
        if (card.value === 'change_color') {
            document.getElementById('color-picker').style.display = 'flex';
            // ××¡×™×¨×™× ×–×× ×™×ª ××”×™×“ ×›×“×™ ×©×œ× ×™×©×—×§×• ×©×•×‘, ××‘×œ ×œ× ×©×•×œ×—×™× ×œ×©×¨×ª ×¢×“ ×”×‘×—×™×¨×”
            return; 
        }

        // ×‘×™×¦×•×¢
        const newHand = [...myHand];
        newHand.splice(index, 1);
        db.ref(`hands/${myId}`).set(newHand);
        db.ref('gameState/pile').set(card);

        if(card.value === 'taki' && !gameState.inTaki) {
            db.ref('gameState/inTaki').set(true);
            showToast("×˜××§×™ ×¤×ª×•×—!");
        } else if (card.value === 'stop') {
             nextTurn(2); // ×“×™×œ×•×’
        } else if (gameState.inTaki) {
             if(newHand.length === 0) closeTaki();
        } else {
             nextTurn(1);
        }
    }

    function drawCard() {
        if (gameState.turn !== myId) return;
        if (gameState.inTaki) { closeTaki(); return; }

        const colors = ['red', 'green', 'blue', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9','stop','+2','taki','change_dir'];
        
        let c = colors[Math.floor(Math.random()*4)];
        let v = values[Math.floor(Math.random()*values.length)];
        if(Math.random() < 0.05) { c='special'; v='change_color'; }

        const newHand = [...myHand, {color:c, value:v}];
        db.ref(`hands/${myId}`).set(newHand);
        nextTurn(1);
    }

    function selectColor(color) {
        document.getElementById('color-picker').style.display = 'none';
        // ××—×™×§×ª ×”×§×œ×£ "×©× ×” ×¦×‘×¢" ××”×™×“ (×× ×™×—×™× ×©×”×•× ×”×™×” ×”××—×¨×•×Ÿ ×©× ×‘×—×¨ ××• ××•×¦××™× ××•×ª×•)
        const idx = myHand.findIndex(c => c.value === 'change_color');
        if(idx > -1) {
            const newHand = [...myHand];
            newHand.splice(idx, 1);
            db.ref(`hands/${myId}`).set(newHand);
        }
        
        db.ref('gameState/pile').set({color: color, value: 'change_color'});
        nextTurn(1);
    }

    function closeTaki() {
        db.ref('gameState/inTaki').set(false);
        nextTurn(1);
    }

    function nextTurn(skip) {
        // ××¦×™××ª ×”×©×—×§×Ÿ ×”×‘×
        const currentIdx = playersList.indexOf(myId);
        const nextIdx = (currentIdx + skip) % playersList.length;
        db.ref('gameState/turn').set(playersList[nextIdx]);
    }

    // --- × ×™×”×•×œ ---
    function startGame() {
        if(playersList.length < 2) return alert("×¦×¨×™×š ×œ×¤×—×•×ª 2 ×©×—×§× ×™×");
        
        // ×—×œ×•×§×ª ×§×œ×¤×™×
        const colors = ['red', 'green', 'blue', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9','stop','+2','taki'];
        
        playersList.forEach(pid => {
            let h = [];
            for(let i=0; i<8; i++) {
                h.push({
                    color: colors[Math.floor(Math.random()*4)], 
                    value: values[Math.floor(Math.random()*values.length)]
                });
            }
            db.ref(`hands/${pid}`).set(h);
        });

        db.ref('gameState').set({
            turn: playersList[0],
            pile: { color: 'red', value: '1' },
            inTaki: false
        });
        
        db.ref('chat').push({text: '×”××©×—×§ ×”×ª×—×™×œ!'});
    }

    function resetGame() {
        if(confirm("×œ××¤×¡ ×”×›×œ?")) {
            db.ref('/').remove();
            location.reload();
        }
    }

    function toggleMenu() {
        const el = document.getElementById('admin-panel');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function showToast(txt) {
        const t = document.getElementById('toast');
        t.innerText = txt;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }
</script>
</body>
</html>
