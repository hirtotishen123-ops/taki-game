<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAKI OFFICIAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #06240d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; height: 100dvh; display: flex; overflow: hidden; }

        /* 住 住 */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /*   */
        #game-ui { display: none; flex: 1; display: flex; width: 100%; position: relative; }
        
        /* 爪' 爪 - 拽  驻专注 */
        #sidebar { width: 180px; background: rgba(0,0,0,0.8); border-left: 1px solid var(--gold); display: flex; flex-direction: column; padding: 5px; font-size: 12px; }
        #chat-messages { flex: 1; overflow-y: auto; margin-bottom: 5px; }

        /* 砖 砖拽 */
        #table-area { flex: 1; position: relative; background: radial-gradient(circle, #1a5d2e, #06240d); border: 5px solid #3d2b1f; display: flex; flex-direction: column; }
        
        /* 砖拽 */
        .player-slot { position: absolute; padding: 5px; background: rgba(0,0,0,0.6); border-radius: 8px; text-align: center; border: 1px solid #444; min-width: 80px; font-size: 11px; }
        .active-turn { border: 2px solid #0f0; box-shadow: 0 0 10px #0f0; }
        .slot-0 { bottom: 120px; left: 50%; transform: translateX(-50%); } /* 转 */
        .slot-1 { left: 10px; top: 50%; transform: translateY(-50%); }
        .slot-2 { top: 10px; left: 50%; transform: translateX(-50%); }
        .slot-3 { right: 10px; top: 50%; transform: translateY(-50%); }

        /* 拽驻 */
        .card { width: 45px; height: 65px; border: 1px solid white; border-radius: 5px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; background: white; color: black; cursor: pointer; margin: 2px; }
        .card.red { background: #e74c3c; color: white; }
        .card.blue { background: #3498db; color: white; }
        .card.green { background: #2ecc71; color: white; }
        .card.yellow { background: #f1c40f; color: black; }
        
        #my-hand { position: absolute; bottom: 5px; width: 100%; display: flex; justify-content: center; flex-wrap: wrap; background: rgba(0,0,0,0.3); padding: 5px; overflow-x: auto; }
        #center-pile { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        
        button { cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color:var(--gold)">TAKI ONLINE</h1>
    <input type="text" id="username" placeholder="住 砖..." style="padding:10px; margin-bottom:10px; border-radius:20px; text-align:center;">
    <button onclick="join()" style="padding:10px 30px; background:var(--gold);">爪专祝</button>
</div>

<div id="game-ui">
    <div id="sidebar">
        <div id="admin-controls" style="display:none">
            <button onclick="dealCards()" style="background:var(--gold); width:100%; margin-bottom:5px;">拽 拽驻</button>
            <button onclick="resetGame()" style="background:red; color:white; width:100%;">驻住</button>
        </div>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="爪'..." style="width:100%; font-size:12px;">
    </div>

    <div id="table-area">
        <div id="status-bar" style="text-align:center; color:var(--gold); padding:5px; font-weight:bold;"></div>
        <div id="p0" class="player-slot slot-0"></div>
        <div id="p1" class="player-slot slot-1"></div>
        <div id="p2" class="player-slot slot-2"></div>
        <div id="p3" class="player-slot slot-3"></div>

        <div id="center-pile">
            <div id="deck" class="card" style="background:#222; color:white;" onclick="drawCard()">拽驻</div>
            <div id="last-card-area"></div>
        </div>

        <div id="my-hand"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myId, myName, isAdmin = false, currentTurn = "";

    function join() {
        let val = document.getElementById('username').value.trim();
        if(!val) return;
        if(val === "") { isAdmin = true; myName = prompt("砖 :") || ""; } else { myName = val; }
        
        const pRef = db.ref('players').push();
        myId = pRef.key;
        pRef.set({ id: myId, name: myName, cardCount: 0 });
        pRef.onDisconnect().remove();

        if(isAdmin) document.getElementById('admin-controls').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        sync();
    }

    function sync() {
        // 砖拽 转专转
        db.ref('players').on('value', snap => {
            const players = snap.val() || {};
            const ids = Object.keys(players);
            document.getElementById('status-bar').innerText = currentTurn === myId ? "转专 砖拽!" : "转 转专...";
            for(let i=0; i<4; i++) {
                const el = document.getElementById('p'+i);
                if(ids[i]) {
                    el.style.display = 'block';
                    el.className = `player-slot slot-${i} ${ids[i] === currentTurn ? 'active-turn' : ''}`;
                    el.innerHTML = `${players[ids[i]].name}<br> ${players[ids[i]].cardCount}`;
                } else { el.style.display = 'none'; }
            }
        });

        // 拽驻 砖
        db.ref('hands/' + myId).on('value', snap => {
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = '';
            const cards = snap.val() || [];
            cards.forEach((c, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${c.color}`;
                cardEl.innerText = c.value;
                cardEl.onclick = () => playCard(index, c);
                handDiv.appendChild(cardEl);
            });
            db.ref('players/' + myId).update({ cardCount: cards.length });
        });

        // 拽祝 砖注 砖
        db.ref('pile').on('value', snap => {
            const c = snap.val();
            const area = document.getElementById('last-card-area');
            if(c) {
                area.innerHTML = `<div class="card ${c.color}">${c.value}</div>`;
            }
        });

        // 转专 
        db.ref('turn').on('value', snap => { currentTurn = snap.val(); });

        // 爪'
        db.ref('chat').on('value', snap => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            snap.forEach(m => { box.innerHTML += `<div><b>${m.val().user}:</b> ${m.val().text}</div>`; });
            box.scrollTop = box.scrollHeight;
        });
    }

    // 驻拽爪转 砖拽
    function dealCards() {
        const colors = ['red', 'blue', 'green', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9','+2','TAKI','STOP'];
        
        db.ref('players').once('value', snap => {
            snap.forEach(player => {
                let hand = [];
                for(let i=0; i<8; i++) {
                    hand.push({ color: colors[Math.floor(Math.random()*4)], value: values[Math.floor(Math.random()*values.length)] });
                }
                db.ref('hands/' + player.key).set(hand);
            });
            db.ref('turn').set(Object.keys(snap.val())[0]);
            db.ref('pile').set({ color: 'red', value: '8' });
        });
    }

    function playCard(index, card) {
        if(currentTurn !== myId) return alert(" 转专!");
        db.ref('pile').once('value', snap => {
            const top = snap.val();
            if(card.color === top.color || card.value === top.value) {
                db.ref('pile').set(card);
                db.ref('hands/' + myId).once('value', hSnap => {
                    let hand = hSnap.val();
                    hand.splice(index, 1);
                    db.ref('hands/' + myId).set(hand);
                    passTurn();
                });
            } else { alert("  拽!"); }
        });
    }

    function drawCard() {
        if(currentTurn !== myId) return;
        const colors = ['red', 'blue', 'green', 'yellow'];
        const values = ['1','3','4','5','6','7','8','9'];
        const newCard = { color: colors[Math.floor(Math.random()*4)], value: values[Math.floor(Math.random()*values.length)] };
        db.ref('hands/' + myId).once('value', snap => {
            let hand = snap.val() || [];
            hand.push(newCard);
            db.ref('hands/' + myId).set(hand);
            passTurn();
        });
    }

    function passTurn() {
        db.ref('players').once('value', snap => {
            const ids = Object.keys(snap.val());
            let nextIdx = (ids.indexOf(myId) + 1) % ids.length;
            db.ref('turn').set(ids[nextIdx]);
        });
    }

    document.getElementById('chat-input').addEventListener('keypress', e => {
        if(e.key === 'Enter') { db.ref('chat').push({ user: myName, text: e.target.value }); e.target.value = ''; }
    });

    function resetGame() { db.ref('/').remove(); location.reload(); }
</script>
</body>
</html>
