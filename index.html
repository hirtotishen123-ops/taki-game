<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>TAKI MASTER - PROFESSIONAL</title>
    <style>
        :root { --gold: #d4af37; --bg: #0a2e12; }
        body { 
            margin: 0; background: var(--bg); color: white; font-family: sans-serif; 
            height: 100vh; width: 100vw; overflow: hidden; display: flex;
        }

        /* מסך כניסה */
        #login-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* שולחן המשחק */
        #game-ui { display: none; flex: 1; position: relative; display: flex; width: 100%; }
        
        #table { 
            flex: 1; position: relative; 
            background: radial-gradient(circle, #1a4a2a 0%, #0a2e12 100%);
            border: 15px solid #3d2b1f; border-radius: 100px; margin: 20px;
        }

        /* מיקומי שחקנים מסביב לשולחן */
        .player-slot { position: absolute; padding: 10px; background: rgba(0,0,0,0.6); border-radius: 10px; border: 2px solid transparent; text-align: center; width: 100px; }
        .slot-bottom { bottom: 10px; left: 50%; transform: translateX(-50%); border-color: var(--gold); }
        .slot-left { left: 20px; top: 50%; transform: translateY(-50%); }
        .slot-top { top: 10px; left: 50%; transform: translateX(-50%); }
        .slot-right { right: 20px; top: 50%; transform: translateY(-50%); }
        .active-turn { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }

        /* קלפים */
        .card { 
            width: 60px; height: 90px; border: 2px solid white; border-radius: 8px; 
            display: inline-flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 18px; cursor: pointer; background: #fff; color: #000;
        }
        #my-hand { position: absolute; bottom: 80px; width: 100%; display: flex; justify-content: center; gap: 5px; }

        /* תפריט צד (צ'אט וכפתורי ניהול) */
        #side-panel { width: 200px; background: #111; display: flex; flex-direction: column; border-right: 2px solid var(--gold); }
        #chat-box { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; }
        .admin-tools { padding: 10px; border-bottom: 2px solid var(--gold); display: none; }

        button { padding: 8px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-danger { background: #ff4444; color: white; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color: var(--gold);">TAKI MASTER</h1>
    <p>הקש "מנהל" כדי לנהל את החדר</p>
    <input type="text" id="username" placeholder="הכנס שם..." style="padding:10px; border-radius:5px; width:200px;">
    <button class="btn-gold" onclick="joinGame()" style="margin-top:10px; width:220px;">היכנס</button>
</div>

<div id="game-ui">
    <div id="side-panel">
        <div id="admin-area" class="admin-tools">
            <button class="btn-gold" onclick="startGame()" style="width:100%; margin-bottom:5px;">התחל משחק</button>
            <button class="btn-danger" onclick="resetAll()" style="width:100%;">איפוס כללי</button>
        </div>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="צ'אט..." style="margin:5px;">
    </div>

    <div id="table">
        <div id="p-slot-0" class="player-slot slot-bottom"></div>
        <div id="p-slot-1" class="player-slot slot-left"></div>
        <div id="p-slot-2" class="player-slot slot-top"></div>
        <div id="p-slot-3" class="player-slot slot-right"></div>

        <div id="center-area" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); display:flex; gap:20px;">
            <div id="deck" class="card" style="background:#222; color:white;">TAKI</div>
            <div id="pile" class="card">?</div>
        </div>

        <div id="my-hand"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId, myName, isAdmin = false;

    window.joinGame = () => {
        myName = document.getElementById('username').value;
        if(!myName) return;
        
        if(myName === "מנהל") isAdmin = true;

        const pRef = push(ref(db, 'players'));
        myId = pRef.key;
        onDisconnect(pRef).remove();
        
        set(pRef, { id: myId, name: myName, hp: 100 });
        
        if(isAdmin) document.getElementById('admin-area').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        initSync();
    };

    function initSync() {
        onValue(ref(db, 'players'), (snap) => {
            const players = snap.val() || {};
            const playerIds = Object.keys(players);
            
            // ניקוי סלוטים
            for(let i=0; i<4; i++) document.getElementById(`p-slot-${i}`).innerHTML = '';

            playerIds.forEach((id, index) => {
                if(index < 4) {
                    const el = document.getElementById(`p-slot-${index}`);
                    el.innerHTML = `<b>${players[id].name}</b><br>❤ ${players[id].hp}`;
                    if(id === myId) el.classList.add('slot-bottom');
                }
            });
        });

        // צ'אט עם Enter
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                push(ref(db, 'chat'), { sender: myName, text: e.target.value });
                e.target.value = '';
            }
        });

        onValue(ref(db, 'chat'), (snap) => {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            const data = snap.val();
            for(let id in data) box.innerHTML += `<div><b>${data[id].sender}:</b> ${data[id].text}</div>`;
            box.scrollTop = box.scrollHeight;
        });
    }

    // פונקציית איפוס למנהל
    window.resetAll = () => {
        if(!isAdmin) return;
        remove(ref(db, '/'));
        location.reload(); // רענון לכולם
    };

    window.startGame = () => {
        alert("המשחק מתחיל! מחלק קלפים...");
        // כאן תבוא פונקציית ה-Deal
    };
</script>
</body>
</html>
