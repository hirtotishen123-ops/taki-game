<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAKI PRO ELITE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff4d4d; --blue: #4d94ff; --green: #4dff88; --yellow: #ffff4d; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; background: #0a2b12; color: white; height: 100dvh; overflow: hidden; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .input-ui { padding: 12px; font-size: 18px; border-radius: 8px; border: none; text-align: center; margin-bottom: 10px; width: 250px; }
        .btn { padding: 12px 30px; background: var(--gold); border: none; border-radius: 25px; font-weight: bold; cursor: pointer; color: black; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        #game-board { display: none; width: 100vw; height: 100dvh; position: relative; background: radial-gradient(circle, #1b5e20, #0a2b12); }
        
        /* 砖拽 */
        .player-slot { position: absolute; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 12px; text-align: center; min-width: 120px; border: 2px solid transparent; z-index: 5; }
        .active-turn { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.05); }
        #slot-bottom { bottom: 120px; left: 50%; transform: translateX(-50%); border: none; background: none; }
        #slot-top { top: 20px; left: 50%; transform: translateX(-50%); }
        #slot-left { top: 50%; left: 20px; transform: translateY(-50%); }
        #slot-right { top: 50%; right: 20px; transform: translateY(-50%); }

        /* 拽驻 */
        .card { width: 50px; height: 75px; background: white; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: black; border: 2px solid white; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); position: relative; }
        .c-red { background: var(--red); color: white; }
        .c-blue { background: var(--blue); color: white; }
        .c-green { background: var(--green); color: black; }
        .c-yellow { background: var(--yellow); color: black; }
        .c-special { background: #222; color: var(--gold); border-color: var(--gold); }

        #my-hand { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 5px; z-index: 100; overflow-x: auto; padding: 5px; }
        #center-area { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; align-items: center; }

        /* 爪 砖驻 */
        .revealed-hand { display: flex; gap: 2px; margin-top: 5px; justify-content: center; flex-wrap: wrap; }
        .card-mini { width: 20px; height: 30px; font-size: 8px; border-width: 1px; }

        #admin-controls { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 1000; }
        #status-bar { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 22px; color: var(--gold); font-weight: bold; pointer-events: none; }
        #close-taki { display: none; position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--red); color: white; z-index: 200; }
    </style>
</head>
<body>

<div id="login-screen" class="overlay">
    <h1 style="color:var(--gold)">TAKI ELITE</h1>
    <input type="text" id="username" class="input-ui" placeholder="砖 砖拽 / ">
    <button class="btn" onclick="preJoin()">住 (Enter)</button>
</div>

<div id="win-screen" class="overlay" style="display:none">
    <h1 id="win-msg" style="color:var(--gold); font-size: 40px;"></h1>
    <div id="reveal-area" style="width: 80%; margin-bottom: 20px;"></div>
    <div id="vote-area">
        <button id="btn-ready" class="btn" onclick="voteNewGame()">  砖拽 砖!</button>
        <p id="vote-count" style="margin-top:10px"></p>
    </div>
    <button id="admin-force-start" class="btn" style="display:none; background:white;" onclick="dealCards()">转  转 ()</button>
</div>

<div id="game-board">
    <div id="status-bar"></div>
    <div id="admin-controls" style="display:none">
        <button class="btn" style="font-size:12px; padding:5px 10px;" onclick="dealCards()">拽转 拽驻</button>
        <button class="btn" style="font-size:12px; padding:5px 10px; background:red; color:white;" onclick="resetGame()">驻住 </button>
    </div>

    <div id="slot-top" class="player-slot"></div>
    <div id="slot-left" class="player-slot"></div>
    <div id="slot-right" class="player-slot"></div>
    <div id="slot-bottom" class="player-slot"></div>

    <div id="center-area">
        <div id="deck" class="card c-special" style="cursor:pointer" onclick="drawFromDeck()">TAKI</div>
        <div id="last-card"></div>
    </div>

    <button id="close-taki" class="btn" onclick="closeTaki()">住专 拽</button>
    <div id="my-hand"></div>
</div>

<div id="color-picker" class="overlay" style="display:none">
    <h2 style="color:white">专 爪注:</h2>
    <div style="display:flex; gap:15px">
        <div class="card c-red" style="width:70px;height:70px;cursor:pointer" onclick="pickColor('red')"></div>
        <div class="card c-blue" style="width:70px;height:70px;cursor:pointer" onclick="pickColor('blue')"></div>
        <div class="card c-green" style="width:70px;height:70px;cursor:pointer" onclick="pickColor('green')"></div>
        <div class="card c-yellow" style="width:70px;height:70px;cursor:pointer" onclick="pickColor('yellow')"></div>
    </div>
</div>

<script>
    const config = {
        apiKey: "AIzaSyDTcYiOhazu3kfn5YhjAnjDBCJMyGaqvA4",
        authDomain: "takimaster-39f6c.firebaseapp.com",
        databaseURL: "https://takimaster-39f6c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "takimaster-39f6c",
        storageBucket: "takimaster-39f6c.firebasestorage.app",
        messagingSenderId: "6879693086",
        appId: "1:6879693086:web:298b7f22fe662a2148210f"
    };

    firebase.initializeApp(config);
    const db = firebase.database();
    let myId, myName, isAdmin = false, gameState = {}, players = [];

    document.getElementById('username').onkeypress = (e) => { if(e.key==='Enter') preJoin(); };

    function preJoin() {
        let name = document.getElementById('username').value.trim();
        if(!name) return;
        if(name === "") {
            isAdmin = true;
            name = prompt(",  拽专  砖拽?") || "";
            document.getElementById('admin-controls').style.display = 'flex';
        }
        join(name);
    }

    function join(name) {
        myName = name;
        const ref = db.ref('players').push();
        myId = ref.key;
        ref.set({ id: myId, name: myName, cards: 0, ready: false });
        ref.onDisconnect().remove();
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-board').style.display = 'block';
        initListeners();
    }

    function initListeners() {
        db.ref('state').on('value', snap => {
            gameState = snap.val() || {};
            if(gameState.winner) showWinScreen();
            else {
                document.getElementById('win-screen').style.display = 'none';
                renderTable();
            }
        });

        db.ref('players').on('value', snap => {
            const data = snap.val() || {};
            players = Object.keys(data);
            updatePlayersUI(data);
            updateVoteUI(data);
        });

        db.ref(`hands/${myId}`).on('value', snap => {
            const hand = snap.val() || [];
            renderHand(hand);
            db.ref(`players/${myId}/cards`).set(hand.length);
            if(hand.length === 0 && gameState.turn === myId && gameState.pile) {
                db.ref('state/winner').set({ id: myId, name: myName });
            }
        });

        db.ref('resetCommand').on('value', snap => {
            if(snap.val() === true && !isAdmin) location.reload();
        });
    }

    function renderTable() {
        if(!gameState.pile) return;
        const pile = document.getElementById('last-card');
        pile.innerHTML = `<div class="card c-${gameState.pile.color}">${gameState.pile.value === 'change_color' ? '' : gameState.pile.value}</div>`;
        document.getElementById('close-taki').style.display = (gameState.turn === myId && gameState.isTaki) ? 'block' : 'none';
        
        let status = "";
        if(gameState.plus2 > 0) status = ` 拽转 ${gameState.plus2} 拽驻!`;
        else if(gameState.turn === myId) status = "转专!";
        document.getElementById('status-bar').innerText = status;
    }

    function updatePlayersUI(data) {
        const slots = ['slot-bottom', 'slot-left', 'slot-top', 'slot-right'];
        slots.forEach(s => document.getElementById(s).style.display = 'none');

        const myIdx = players.indexOf(myId);
        players.forEach((pid, i) => {
            let rel = (i - myIdx + players.length) % players.length;
            let slotId = (rel === 0) ? 'slot-bottom' : (rel === 1) ? (players.length === 2 ? 'slot-top' : 'slot-left') : (rel === 2) ? 'slot-top' : 'slot-right';
            const el = document.getElementById(slotId);
            el.style.display = 'block';
            el.className = `player-slot ${gameState.turn === pid ? 'active-turn' : ''}`;
            
            if(rel === 0) el.innerHTML = ` ${data[pid].cards}`;
            else el.innerHTML = `<b>${data[pid].name}</b><br> ${data[pid].cards}`;
        });
    }

    function renderHand(hand) {
        const container = document.getElementById('my-hand');
        container.innerHTML = '';
        hand.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = `card c-${c.color} ${c.color==='special'?'c-special':''}`;
            div.style.cursor = 'pointer';
            div.innerHTML = c.value === 'change_color' ? '' : c.value;
            div.onclick = () => playCard(i, c);
            container.appendChild(div);
        });
    }

    function playCard(idx, card) {
        if(gameState.turn !== myId) return;
        const top = gameState.pile;
        let valid = false;

        if(gameState.plus2 > 0) {
            if(card.value === '+2') valid = true;
        } else if(gameState.isTaki) {
            if(card.color === top.color) valid = true;
        } else {
            if(card.color === top.color || card.value === top.value || card.color === 'special') valid = true;
        }

        if(!valid) return;

        db.ref(`hands/${myId}`).once('value', s => {
            let h = s.val(); h.splice(idx, 1);
            db.ref(`hands/${myId}`).set(h);

            if(card.value === 'change_color') {
                window.tempIdx = idx; document.getElementById('color-picker').style.display='flex';
                return;
            }

            db.ref('state').update({
                pile: card,
                plus2: (card.value === '+2') ? (gameState.plus2 + 2) : 0,
                isTaki: (card.value === 'taki')
            });

            if(card.value !== 'taki' && !gameState.isTaki) passTurn(card.value === 'stop' ? 2 : 1);
        });
    }

    function drawFromDeck() {
        if(gameState.turn !== myId) return;
        const count = gameState.plus2 > 0 ? gameState.plus2 : 1;
        
        db.ref(`hands/${myId}`).once('value', s => {
            let h = s.val() || [];
            for(let i=0; i<count; i++) h.push(generateCard());
            db.ref(`hands/${myId}`).set(h);
            db.ref('state').update({ plus2: 0, isTaki: false });
            passTurn(1);
        });
    }

    function generateCard() {
        const colors = ['red','blue','green','yellow'];
        const vals = ['1','3','4','5','6','7','8','9','stop','+2','taki'];
        let c = colors[Math.floor(Math.random()*4)], v = vals[Math.floor(Math.random()*vals.length)];
        if(Math.random() < 0.1) { c='special'; v='change_color'; }
        return {color:c, value:v};
    }

    function passTurn(steps) {
        const next = players[(players.indexOf(myId) + steps) % players.length];
        db.ref('state/turn').set(next);
    }

    function closeTaki() {
        db.ref('state/isTaki').set(false);
        passTurn(gameState.pile.value === 'stop' ? 2 : 1);
    }

    function pickColor(c) {
        db.ref('state/pile').set({color:c, value:''});
        document.getElementById('color-picker').style.display='none';
        passTurn(1);
    }

    // --- 爪 住 ---
    function showWinScreen() {
        document.getElementById('win-screen').style.display = 'flex';
        document.getElementById('win-msg').innerText = `${gameState.winner.name} 爪!`;
        
        // 砖驻转 拽驻
        db.ref('hands').once('value', snap => {
            const allHands = snap.val() || {};
            const area = document.getElementById('reveal-area');
            area.innerHTML = '';
            players.forEach(pid => {
                const pName = (pid === myId) ? "" : (gameState.winner.id === pid ? "爪" : "砖拽");
                let html = `<div style="margin-bottom:10px"><b>${pName}:</b><div class="revealed-hand">`;
                (allHands[pid] || []).forEach(c => {
                    html += `<div class="card card-mini c-${c.color}">${c.value === 'change_color' ? '' : c.value}</div>`;
                });
                html += `</div></div>`;
                area.innerHTML += html;
            });
        });

        if(isAdmin) {
            setTimeout(() => { document.getElementById('admin-force-start').style.display = 'block'; }, 5000);
        }
    }

    function voteNewGame() {
        db.ref(`players/${myId}/ready`).set(true);
        document.getElementById('btn-ready').style.opacity = '0.5';
        document.getElementById('btn-ready').disabled = true;
    }

    function updateVoteUI(data) {
        let readyCount = 0;
        players.forEach(pid => { if(data[pid].ready) readyCount++; });
        document.getElementById('vote-count').innerText = `: ${readyCount} 转 ${players.length}`;
        
        if(readyCount === players.length && isAdmin && players.length > 0) {
            dealCards(); // 转 转   
        }
    }

    // --- 注专转 ---
    function dealCards() {
        players.forEach(pid => {
            let h = []; for(let i=0; i<8; i++) h.push(generateCard());
            db.ref(`hands/${pid}`).set(h);
            db.ref(`players/${pid}/ready`).set(false);
        });
        db.ref('state').set({ turn: players[0], pile: generateCard(), plus2: 0, isTaki: false });
        db.ref('resetCommand').set(false);
    }

    function resetGame() {
        db.ref('resetCommand').set(true);
        db.ref('state').remove();
        db.ref('hands').remove();
        db.ref('chat').remove();
        //   转专注, 专拽 驻住 转 住 砖
        document.getElementById('win-screen').style.display = 'none';
        document.getElementById('btn-ready').disabled = false;
        document.getElementById('btn-ready').style.opacity = '1';
    }
</script>
</body>
</html>
